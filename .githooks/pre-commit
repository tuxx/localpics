#!/bin/bash

echo "ðŸ”§ Running go fmt on staged Go files..."

staged_go_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$')

formatted_any=0

for file in $staged_go_files; do
    if [ -f "$file" ]; then
        original_hash=$(git hash-object "$file")
        go fmt "$file" > /dev/null
        new_hash=$(git hash-object "$file")
        if [ "$original_hash" != "$new_hash" ]; then
            git add "$file"
            echo "âœ¨ Formatted and re-staged: $file"
            formatted_any=1
        fi
    fi
done

if [ "$formatted_any" -eq 1 ]; then
    echo "go fmt was applied." > .git/.gofmt-flag
fi

echo "ðŸ”§ Checking for staged template/index.template..."

if git diff --cached --name-only --diff-filter=ACM | grep -q "^template/index\.template$"; then
    if ! command -v prettier &> /dev/null; then
        echo "âŒ Prettier is not installed. Please install it."
        exit 1
    fi

    if [ -f template/index.template ]; then
        echo "âœ¨ Running prettier on template/index.template..."
        prettier --parser html --write template/index.template > /dev/null
        git add template/index.template
        echo "prettier was applied." > .git/.prettier-flag
    fi
fi

echo "âœ… Formatting complete."
exit 0

